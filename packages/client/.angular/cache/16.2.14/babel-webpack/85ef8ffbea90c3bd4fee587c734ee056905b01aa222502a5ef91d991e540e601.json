{"ast":null,"code":"import { createCdnUrl, createCdnUrlModifiers } from '../../../utils/cdn-utils.js';\nimport { EditorButtonControl } from './EditorButtonControl.js';\nimport { FAKE_ORIGINAL_FILTER } from './EditorSlider.js';\nimport { COMMON_OPERATIONS, transformationsToOperations } from './lib/transformationUtils.js';\nimport { preloadImage } from './lib/preloadImage.js';\nexport class EditorFilterControl extends EditorButtonControl {\n  init$ = {\n    ...this.init$,\n    active: false,\n    title: '',\n    icon: '',\n    isOriginal: false,\n    iconSize: '20',\n    'on.click': null\n  };\n  _previewSrc() {\n    let previewSize = parseInt(window.getComputedStyle(this).getPropertyValue('--l-base-min-width'), 10);\n    let dpr = window.devicePixelRatio;\n    let size = Math.ceil(dpr * previewSize);\n    let quality = dpr >= 2 ? 'lightest' : 'normal';\n    let filterValue = 100;\n\n    /** @type {import('./types.js').Transformations} */\n    let transformations = {\n      ...this.$['*editorTransformations']\n    };\n    transformations[this._operation] = this._filter !== FAKE_ORIGINAL_FILTER ? {\n      name: this._filter,\n      amount: filterValue\n    } : undefined;\n    return createCdnUrl(this._originalUrl, createCdnUrlModifiers(COMMON_OPERATIONS, transformationsToOperations(transformations), `quality/${quality}`, `scale_crop/${size}x${size}/center`));\n  }\n\n  /**\n   * @param {IntersectionObserverEntry[]} entries\n   * @param {IntersectionObserver} observer\n   */\n  _observerCallback(entries, observer) {\n    let intersectionEntry = entries[0];\n    if (intersectionEntry.isIntersecting) {\n      let src = this.proxyUrl(this._previewSrc());\n      let previewEl = this.ref['preview-el'];\n      let {\n        promise,\n        cancel\n      } = preloadImage(src);\n      this._cancelPreload = cancel;\n      promise.catch(err => {\n        this.$['*networkProblems'] = true;\n        console.error('Failed to load image', {\n          error: err\n        });\n      }).finally(() => {\n        previewEl.style.backgroundImage = `url(${src})`;\n        previewEl.setAttribute('loaded', '');\n        observer.unobserve(this);\n      });\n    } else {\n      this._cancelPreload && this._cancelPreload();\n    }\n  }\n  initCallback() {\n    super.initCallback();\n    this.$['on.click'] = e => {\n      if (!this.$.active) {\n        this.$['*sliderEl'].setOperation(this._operation, this._filter);\n        this.$['*sliderEl'].apply();\n      } else if (!this.$.isOriginal) {\n        this.$['*sliderEl'].setOperation(this._operation, this._filter);\n        this.$['*showSlider'] = true;\n      }\n      this.$['*currentFilter'] = this._filter;\n    };\n    this.defineAccessor('filter', filter => {\n      this._operation = 'filter';\n      this._filter = filter;\n      this.$.isOriginal = filter === FAKE_ORIGINAL_FILTER;\n      this.$.icon = this.$.isOriginal ? 'original' : 'slider';\n    });\n    this._observer = new window.IntersectionObserver(this._observerCallback.bind(this), {\n      threshold: [0, 1]\n    });\n    let originalUrl = this.$['*originalUrl'];\n    this._originalUrl = originalUrl;\n    if (this.$.isOriginal) {\n      this.ref['icon-el'].classList.add('original-icon');\n    } else {\n      this._observer.observe(this);\n    }\n    this.sub('*currentFilter', currentFilter => {\n      this.$.active = currentFilter && currentFilter === this._filter;\n    });\n    this.sub('isOriginal', isOriginal => {\n      this.$.iconSize = isOriginal ? 40 : 20;\n    });\n    this.sub('active', active => {\n      if (this.$.isOriginal) {\n        return;\n      }\n      let iconEl = this.ref['icon-el'];\n      iconEl.style.opacity = active ? '1' : '0';\n      let previewEl = this.ref['preview-el'];\n      if (active) {\n        previewEl.style.opacity = '0';\n      } else if (previewEl.style.backgroundImage) {\n        previewEl.style.opacity = '1';\n      }\n    });\n    this.sub('*networkProblems', networkProblems => {\n      if (!networkProblems) {\n        let src = this.proxyUrl(this._previewSrc());\n        let previewEl = this.ref['preview-el'];\n        if (previewEl.style.backgroundImage) {\n          previewEl.style.backgroundImage = 'none';\n          previewEl.style.backgroundImage = `url(${src})`;\n        }\n      }\n    });\n  }\n  destroyCallback() {\n    super.destroyCallback();\n    this._observer?.disconnect();\n    this._cancelPreload && this._cancelPreload();\n  }\n}\nEditorFilterControl.template = /* HTML */`\n  <div class=\"before\"></div>\n  <div class=\"preview\" ref=\"preview-el\"></div>\n  <lr-icon size=\"40\" ref=\"icon-el\" set=\"@name: icon; @size: iconSize;\"></lr-icon>\n`;","map":{"version":3,"names":["createCdnUrl","createCdnUrlModifiers","EditorButtonControl","FAKE_ORIGINAL_FILTER","COMMON_OPERATIONS","transformationsToOperations","preloadImage","EditorFilterControl","init$","active","title","icon","isOriginal","iconSize","_previewSrc","previewSize","parseInt","window","getComputedStyle","getPropertyValue","dpr","devicePixelRatio","size","Math","ceil","quality","filterValue","transformations","$","_operation","_filter","name","amount","undefined","_originalUrl","_observerCallback","entries","observer","intersectionEntry","isIntersecting","src","proxyUrl","previewEl","ref","promise","cancel","_cancelPreload","catch","err","console","error","finally","style","backgroundImage","setAttribute","unobserve","initCallback","e","setOperation","apply","defineAccessor","filter","_observer","IntersectionObserver","bind","threshold","originalUrl","classList","add","observe","sub","currentFilter","iconEl","opacity","networkProblems","destroyCallback","disconnect","template"],"sources":["/Users/David/Documents/own_projects/mp4-to-gif/node_modules/@uploadcare/blocks/blocks/CloudImageEditor/src/EditorFilterControl.js"],"sourcesContent":["import { createCdnUrl, createCdnUrlModifiers } from '../../../utils/cdn-utils.js';\nimport { EditorButtonControl } from './EditorButtonControl.js';\nimport { FAKE_ORIGINAL_FILTER } from './EditorSlider.js';\nimport { COMMON_OPERATIONS, transformationsToOperations } from './lib/transformationUtils.js';\nimport { preloadImage } from './lib/preloadImage.js';\n\nexport class EditorFilterControl extends EditorButtonControl {\n  init$ = {\n    ...this.init$,\n    active: false,\n    title: '',\n    icon: '',\n    isOriginal: false,\n    iconSize: '20',\n    'on.click': null,\n  };\n\n  _previewSrc() {\n    let previewSize = parseInt(window.getComputedStyle(this).getPropertyValue('--l-base-min-width'), 10);\n    let dpr = window.devicePixelRatio;\n    let size = Math.ceil(dpr * previewSize);\n    let quality = dpr >= 2 ? 'lightest' : 'normal';\n    let filterValue = 100;\n\n    /** @type {import('./types.js').Transformations} */\n    let transformations = { ...this.$['*editorTransformations'] };\n    transformations[this._operation] =\n      this._filter !== FAKE_ORIGINAL_FILTER\n        ? {\n            name: this._filter,\n            amount: filterValue,\n          }\n        : undefined;\n\n    return createCdnUrl(\n      this._originalUrl,\n      createCdnUrlModifiers(\n        COMMON_OPERATIONS,\n        transformationsToOperations(transformations),\n        `quality/${quality}`,\n        `scale_crop/${size}x${size}/center`\n      )\n    );\n  }\n\n  /**\n   * @param {IntersectionObserverEntry[]} entries\n   * @param {IntersectionObserver} observer\n   */\n  _observerCallback(entries, observer) {\n    let intersectionEntry = entries[0];\n    if (intersectionEntry.isIntersecting) {\n      let src = this.proxyUrl(this._previewSrc());\n      let previewEl = this.ref['preview-el'];\n      let { promise, cancel } = preloadImage(src);\n      this._cancelPreload = cancel;\n      promise\n        .catch((err) => {\n          this.$['*networkProblems'] = true;\n          console.error('Failed to load image', { error: err });\n        })\n        .finally(() => {\n          previewEl.style.backgroundImage = `url(${src})`;\n          previewEl.setAttribute('loaded', '');\n\n          observer.unobserve(this);\n        });\n    } else {\n      this._cancelPreload && this._cancelPreload();\n    }\n  }\n\n  initCallback() {\n    super.initCallback();\n\n    this.$['on.click'] = (e) => {\n      if (!this.$.active) {\n        this.$['*sliderEl'].setOperation(this._operation, this._filter);\n        this.$['*sliderEl'].apply();\n      } else if (!this.$.isOriginal) {\n        this.$['*sliderEl'].setOperation(this._operation, this._filter);\n        this.$['*showSlider'] = true;\n      }\n\n      this.$['*currentFilter'] = this._filter;\n    };\n\n    this.defineAccessor('filter', (filter) => {\n      this._operation = 'filter';\n      this._filter = filter;\n      this.$.isOriginal = filter === FAKE_ORIGINAL_FILTER;\n      this.$.icon = this.$.isOriginal ? 'original' : 'slider';\n    });\n\n    this._observer = new window.IntersectionObserver(this._observerCallback.bind(this), {\n      threshold: [0, 1],\n    });\n\n    let originalUrl = this.$['*originalUrl'];\n    this._originalUrl = originalUrl;\n\n    if (this.$.isOriginal) {\n      this.ref['icon-el'].classList.add('original-icon');\n    } else {\n      this._observer.observe(this);\n    }\n\n    this.sub('*currentFilter', (currentFilter) => {\n      this.$.active = currentFilter && currentFilter === this._filter;\n    });\n\n    this.sub('isOriginal', (isOriginal) => {\n      this.$.iconSize = isOriginal ? 40 : 20;\n    });\n\n    this.sub('active', (active) => {\n      if (this.$.isOriginal) {\n        return;\n      }\n      let iconEl = this.ref['icon-el'];\n      iconEl.style.opacity = active ? '1' : '0';\n\n      let previewEl = this.ref['preview-el'];\n      if (active) {\n        previewEl.style.opacity = '0';\n      } else if (previewEl.style.backgroundImage) {\n        previewEl.style.opacity = '1';\n      }\n    });\n\n    this.sub('*networkProblems', (networkProblems) => {\n      if (!networkProblems) {\n        let src = this.proxyUrl(this._previewSrc());\n        let previewEl = this.ref['preview-el'];\n        if (previewEl.style.backgroundImage) {\n          previewEl.style.backgroundImage = 'none';\n          previewEl.style.backgroundImage = `url(${src})`;\n        }\n      }\n    });\n  }\n\n  destroyCallback() {\n    super.destroyCallback();\n    this._observer?.disconnect();\n    this._cancelPreload && this._cancelPreload();\n  }\n}\n\nEditorFilterControl.template = /* HTML */ `\n  <div class=\"before\"></div>\n  <div class=\"preview\" ref=\"preview-el\"></div>\n  <lr-icon size=\"40\" ref=\"icon-el\" set=\"@name: icon; @size: iconSize;\"></lr-icon>\n`;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}